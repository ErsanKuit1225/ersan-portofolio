<script>
  import {
    Label,
    ActionButton,
    ModalContent,
    Multiselect,
    InputDropdown,
    Body,
    Input,
    notifications,
    Select,
    Toggle,
    Layout,
  } from "@budibase/bbui"
  import { createValidationStore, emailValidator } from "helpers/validation"
  import { users, groups } from "stores/portal"
  import { createEventDispatcher } from "svelte"
  import { Constants } from "@budibase/frontend-core"

  export let showOnboardingTypeModal

  const dispatch = createEventDispatcher()
  const password = Math.random().toString(36).substring(2, 22)
  const options = ["Email onboarding", "Basic onboarding"]
  const [email, error, touched] = createValidationStore("", emailValidator)
  let disabled

  let builder
  let admin
  let selected = "Email onboarding"

  $: userData = [{ email: "", role: "", groups: [], error: null }]

  function addNewInput() {
    userData = [...userData, { email: "", role: "" }]
  }

  function setValue(e) {
    userData.groups = e.detail
  }
  $: basic = selected === "Basic onboarding"

  function addUser() {
    if (basic) {
      createUser()
    } else {
      createUserFlow()
    }
  }

  async function createUser() {
    try {
      await users.create({
        email: $email,
        password,
        builder,
        admin,
        forceResetPassword: true,
      })
      notifications.success("Successfully created user")
      dispatch("created")
    } catch (error) {
      notifications.error("Error creating user")
    }
  }

  async function createUserFlow() {
    try {
      const res = await users.invite({ email: $email, builder, admin })
      notifications.success(res.message)
    } catch (error) {
      notifications.error("Error inviting user")
    }
  }
</script>

<ModalContent
  onConfirm={() => {
    showOnboardingTypeModal()
    addUser()
    dispatch("change", userData)
  }}
  size="M"
  title="Add new user"
  confirmText="Add user"
  confirmDisabled={disabled}
  cancelText="Cancel"
  showCloseIcon={false}
>
  <Layout noPadding gap="XS">
    <Label>Email Address</Label>

    {#each userData as input, index}
      <InputDropdown
        inputType="email"
        bind:inputValue={input.email}
        bind:dropdownValue={input.role}
        options={Constants.BbRoles}
        error={input.error}
      />
    {/each}
    <div>
      <ActionButton on:click={addNewInput} icon="Add">Add email</ActionButton>
    </div>
    <div>
      <Body size="S">
        If you have SMTP configured and an email for the new user, you can use
        the automated email onboarding flow. Otherwise, use our basic onboarding
        process with autogenerated passwords.
      </Body>
      <Select
        placeholder={null}
        bind:value={selected}
        {options}
        label="Add new user via:"
      />

      <Input
        type="email"
        label="Email"
        bind:value={$email}
        error={$touched && $error}
        placeholder="john@doe.com"
      />

      {#if basic}
        <Input disabled label="Password" value={password} />
      {/if}
    </div></Layout
  >

  <Multiselect
    placeholder="Select User Groups"
    on:change={e => setValue(e)}
    label="User Groups"
    options={$groups}
    getOptionLabel={option => option.name}
    getOptionValue={option => option.name}
  />
</ModalContent>

<style>
  :global(.spectrum-Picker) {
    border-top-left-radius: 0px;
  }
</style>
